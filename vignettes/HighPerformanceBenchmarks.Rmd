---
title: "High Performance Benchmarks"
author: "Joseph Wood"
date: "9/14/2021"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
vignette: >
  %\VignetteIndexEntry{High Performance Benchmarks}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

This document serves as an overview for measuring the performance of `RcppAlgos` against other tools that were determined to be efficient for generating combinations and permutations from the benchmarks found here: [Permutations and combinations with/without replacement and for distinct/non-distinct items/multiset
](<https://stackoverflow.com/a/47983855/4408538>). You will note that the examples in that post were relatively small. The benchmarks below will focus on larger examples where performance really matters and for this reason we only consider the packages [arrangements](<https://cran.r-project.org/package=arrangements>), [partitions](<https://cran.r-project.org/package=partitions>), and [RcppAlgos](<https://cran.r-project.org/package=RcppAlgos>).

## Setup Information

For the benchmarks below, we used a `Macbook Pro i7 16Gb` machine. We also tested on a Windows and Linux machine with similar specs and obtained similar results.

```r
library(RcppAlgos)
library(partitions)
library(arrangements)
library(microbenchmark)
pertinent_output <- capture.output(sessionInfo())

options(digits = 4)
cat(paste(pertinent_output[1:3], collapse = "\n"))
#> R version 3.6.2 (2019-12-12)
#> Platform: x86_64-apple-darwin15.6.0 (64-bit)
#> Running under: macOS Mojave 10.14.6

cat(pertinent_output[which(pertinent_output == "other attached packages:") + 1L])
#> [1] microbenchmark_1.4-7 partitions_1.9-22    arrangements_1.1.9   RcppAlgos_2.5.0

numThreads <- as.integer(RcppAlgos::stdThreadMax() / 2)
print(numThreads)
#> [1] 4
```

## Combinations

### Combinations - Distinct

```r
set.seed(13)
v1 <- sort(sample(100, 30))
m <- 21
t1 <- comboGeneral(v1, m, Parallel = T)
t2 <- combinations(v1, m)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 14307150       21
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = comboGeneral(v1, m, nThreads = numThreads),
               cbRcppAlgosSer = comboGeneral(v1, m),
        	   cbArrangements = combinations(v1, m),
        	   times = 15, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    15  a 
##  cbRcppAlgosSer 3.328 2.354 2.380  2.342 2.291 2.299    15   b
##  cbArrangements 3.346 2.374 2.397  2.375 2.323 2.264    15   b
```

### Combinations - Repetition

```r
v2 <- v1[1:10]
m <- 20
t1 <- comboGeneral(v2, m, repetition = TRUE, nThreads = numThreads)
t2 <- combinations(v2, m, replace = TRUE)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 10015005       20
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = comboGeneral(v2, m, TRUE, nThreads = numThreads),
               cbRcppAlgosSer = comboGeneral(v2, m, TRUE),
               cbArrangements = combinations(v2, m, replace = TRUE),
               times = 15, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    15 a  
##  cbRcppAlgosSer 2.050 2.255 2.211  2.232 2.214 2.146    15  b 
##  cbArrangements 2.298 2.274 2.259  2.283 2.252 2.200    15   c
```

### Combinations - Multisets

```r
myFreqs <- c(2, 4, 4, 5, 3, 2, 2, 2, 3, 4, 1, 4, 2, 5)
v3 <- as.integer(c(1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610))
t1 <- comboGeneral(v3, 20, freqs = myFreqs, nThreads = numThreads)
t2 <- combinations(freq = myFreqs, k = 20, x = v3)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 14594082       20
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = comboGeneral(v3, 20, freqs = myFreqs, nThreads = numThreads),
               cbRcppAlgosSer = comboGeneral(v3, 20, freqs = myFreqs),
               cbArrangements = combinations(freq = myFreqs, k = 20, x = v3),
               times = 10, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    10 a  
##  cbRcppAlgosSer 2.407 2.421 2.391  2.385 2.356 2.373    10  b 
##  cbArrangements 3.601 3.808 3.730  3.746 3.699 3.703    10   c
```

## Permutations

### Permutations - Distinct

```r
v4 <- as.integer(c(2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59))
t1 <- permuteGeneral(v4, 6, nThreads = numThreads)
t2 <- permutations(v4, 6)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 8910720       6
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = permuteGeneral(v4, 6, nThreads = numThreads),
               cbRcppAlgosSer = permuteGeneral(v4, 6),
               cbArrangements = permutations(v4, 6),
               times = 15, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    15 a  
##  cbRcppAlgosSer 2.318 2.274 2.120  2.155 2.153 1.715    15  b 
##  cbArrangements 3.244 3.112 2.848  2.951 3.379 1.881    15   c


## Indexing permutation example with the partitions package
t1 <- permuteGeneral(11, nThreads = 4)
t2 <- permutations(11)
t3 <- perms(11)

dim(t1)
#> [1] 39916800       11

identical(t1, t2)
#> [1] TRUE
identical(t1, t(as.matrix(t3)))
#> [1] TRUE
rm(t1, t2, t3)
invisible(gc())

microbenchmark(cbRcppAlgosPar = permuteGeneral(11, nThreads = 4),
               cbRcppAlgosSer = permuteGeneral(11),
               cbArrangements = permutations(11),
               cbPartitions   = perms(11),
               times = 5, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000     5 a  
##  cbRcppAlgosSer 2.970 2.974 2.423  2.981 1.668 2.285     5  b 
##  cbArrangements 3.432 3.421 2.649  3.355 2.007 2.077     5  b 
##    cbPartitions 9.793 9.977 7.625 10.065 5.678 5.830     5   c
```

### Permutations - Repetition

```r
v5 <- v3[1:5]
t1 <- permuteGeneral(v5, 10, repetition = TRUE, nThreads = numThreads)
t2 <- permutations(v5, 10, replace = TRUE)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 9765625      10
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = permuteGeneral(v5, 10, TRUE, nThreads = numThreads),
               cbRcppAlgosSer = permuteGeneral(v5, 10, TRUE),
               cbArrangements = permutations(x = v5, k = 10, replace = TRUE),
               times = 10, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    10  a 
##  cbRcppAlgosSer 3.038 2.975 3.867  2.875 2.944 7.107    10   b
##  cbArrangements 3.017 2.968 2.882  2.876 2.819 2.697    10   b
```

### Permutations - Multisets

```r
v6 <- sort(runif(12))
t1 <- permuteGeneral(v6, 7, freqs = rep(1:3, 4), nThreads = numThreads)
t2 <- permutations(freq = rep(1:3, 4), k = 7, x = v6)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 19520760        7
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = permuteGeneral(v6, 7, freqs = rep(1:3, 4), nThreads = numThreads),
               cbRcppAlgosSer = permuteGeneral(v6, 7, freqs = rep(1:3, 4)),
               cbArrangements = permutations(freq = rep(1:3, 4), k = 7, x = v6),
               times = 10, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median   uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.00 1.000    10  a 
##  cbRcppAlgosSer 3.088 3.032 2.105  2.989 1.26 1.808    10   b
##  cbArrangements 3.271 3.231 2.307  3.159 1.88 1.894    10   b
```

## Partitions

### Partitions - Distinct

#### All Distinct Partitions

```r
t1 <- comboGeneral(0:140, freqs=c(140, rep(1, 140)),
				   constraintFun = "sum", comparisonFun = "==",
				   limitConstraints = 140)
t2 <- partitions(140, distinct = TRUE)
t3 <- diffparts(140)

# Each package has different output formats... we only examine dimensions
# and that each result is a partition of 140
identical(dim(t1), dim(t2))
#> [1] TRUE
identical(dim(t1), dim(t(t3)))
#> [1] TRUE
all(rowSums(t1) == 140)
#> [1] TRUE
all(rowSums(t2) == 140)
#> [1] TRUE
all(colSums(t3) == 140)
#> [1] TRUE

dim(t1)
#> [1] 9617150      16
rm(t1, t2, t3)
invisible(gc())
microbenchmark(cbRcppAlgosPar = partitionsGeneral(0:140, freqs=c(140, rep(1, 140)), nThreads = numThreads),
               cbRcppAlgosSer = partitionsGeneral(0:140, freqs=c(140, rep(1, 140))),
               cbArrangements = partitions(140, distinct = TRUE),
               cbPartitions   = diffparts(140),
               times = 10, unit = "relative")
## Unit: relative
##            expr    min     lq   mean median     uq    max neval cld
##  cbRcppAlgosPar  1.000  1.000  1.000  1.000  1.000  1.000    10 a  
##  cbRcppAlgosSer  2.848  2.790  2.543  2.728  2.410  2.356    10  b 
##  cbArrangements  2.633  2.577  2.392  2.570  2.201  2.253    10  b 
##    cbPartitions 18.697 18.888 15.238 18.746 11.744 11.972    10   c
```

#### Restricted Distinct Partitions

```r
t1 <- comboGeneral(160, 10,
				   constraintFun = "sum", comparisonFun = "==",
				   limitConstraints = 160)
t2 <- partitions(160, 10, distinct = TRUE)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 8942920      10
rm(t1, t2)
invisible(gc())
microbenchmark(cbRcppAlgosPar = partitionsGeneral(160, 10, nThreads = numThreads),
               cbRcppAlgosSer = partitionsGeneral(160, 10),
               cbArrangements = partitions(160, 10, distinct = TRUE),
               times = 10, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    10  a 
##  cbRcppAlgosSer 2.924 2.889 2.097  2.838 1.113 1.620    10   b
##  cbArrangements 3.210 3.178 2.065  3.150 1.209 1.128    10   b
```

### Partitions - Repetition

#### All Partitions

```r
t1 <- comboGeneral(0:65, repetition = TRUE, constraintFun = "sum",
 		           comparisonFun = "==", limitConstraints = 65)
t2 <- partitions(65)
t3 <- parts(65)

# Each package has different output formats... we only dimensions
# and that each result is a partition of 65
identical(dim(t1), dim(t2))
#> [1] TRUE
identical(dim(t1), dim(t(t3)))
#> [1] TRUE
all(rowSums(t1) == 65)
#> [1] TRUE
all(rowSums(t2) == 65)
#> [1] TRUE
all(colSums(t3) == 65)
#> [1] TRUE
dim(t1)
#> [1] 2012558      65
rm(t1, t2, t3)
invisible(gc())
microbenchmark(cbRcppAlgosPar = partitionsGeneral(0:65, repetition = TRUE,
                                                  nThreads = numThreads),
               cbRcppAlgosSer = partitionsGeneral(0:65, repetition = TRUE),
 			   cbArrangements = partitions(65),
 			   cbPartitions   = parts(65),
 			   times = 20, unit = "relative")
## Unit: relative
##            expr   min    lq  mean median    uq   max neval cld
##  cbRcppAlgosPar 1.000 1.000 1.000  1.000 1.000 1.000    20 a  
##  cbRcppAlgosSer 2.570 2.281 2.079  2.132 2.064 1.530    20  b 
##  cbArrangements 2.749 2.229 2.065  2.110 2.023 1.355    20  b 
##    cbPartitions 9.527 7.864 7.699  8.202 8.034 4.344    20   c
```

#### Restricted Partitions

```r
t1 <- comboGeneral(100, 15, TRUE, constraintFun = "sum",
                   comparisonFun = "==", limitConstraints = 100)
t2 <- partitions(100, 15)
identical(t1, t2)
#> [1] TRUE
dim(t1)
#> [1] 9921212      15
rm(t1, t2)

# This takes a really long time... not because of restrictedparts,
# but because apply is not that fast. This transformation is
# needed for proper comparisons. As a result, we will compare
# a smaller example
# t3 <- t(apply(as.matrix(restrictedparts(100, 15, include.zero = F)), 2, sort))
t3 <- t(apply(as.matrix(restrictedparts(50, 15, include.zero = F)), 2, sort))
identical(partitions(50, 15), t3)
#> [1] TRUE
rm(t3)
invisible(gc())
microbenchmark(cbRcppAlgosPar = partitionsGeneral(100, 15, TRUE,
                                                  nThreads = numThreads),
               cbRcppAlgosSer = partitionsGeneral(100, 15, TRUE),
		       cbArrangements = partitions(100, 15),
		       cbPartitions   = restrictedparts(100, 15,
		                                        include.zero = FALSE),
		       times = 10, unit = "relative")
## Unit: relative
##            expr    min     lq  mean median    uq   max neval cld
##  cbRcppAlgosPar  1.000  1.000 1.000  1.000 1.000 1.000    10 a  
##  cbRcppAlgosSer  2.770  2.674 1.945  1.599 1.826 1.918    10  b 
##  cbArrangements  2.735  2.662 1.926  1.601 1.718 1.902    10  b 
##    cbPartitions 14.865 14.528 9.841  8.523 8.448 8.854    10   c
```

### Partitions - Multisets

Currenlty, `RcppAlgos` is the only package capable of efficiently generating partitions of multisets. Therefore, we will only time `RcppAlgos` and use this as a reference for future improvements.

```r
t1 <- comboGeneral(120, 10, freqs=rep(1:8, 15),
				   constraintFun = "sum", comparisonFun = "==",
				   limitConstraints = 120)
dim(t1)
#> [1] 7340225      10
all(rowSums(t1) == 120)
#> [1] TRUE
microbenchmark(cbRcppAlgos = partitionsGeneral(120, 10, freqs=rep(1:8, 15)),
               times = 10)
## Unit: milliseconds
##         expr   min      lq   mean median     uq    max neval
##  cbRcppAlgos 715.2   724.8  750.5  735.3  791.5  804.5    10

### In RcppAlgos 2.3.6 - 2.4.3
#> Unit: seconds
#>         expr   min      lq   mean median     uq    max neval
#>  cbRcppAlgos 1172.9 1175.1 1223.5 1193.3 1200.5 1482.0    10    10
```
